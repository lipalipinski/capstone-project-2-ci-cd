pipeline {
    agent {label 'ec2'}

    environment {
        TF_CLI_ARGS="-no-color"
        TF_IN_AUTOMATION="true" // effective if not empty
    }

    parameters {
        booleanParam(name: 'DESTROY_DB', defaultValue: false, description: 'Check out to permanently delete database resource')
    }

    stages {
        stage('tf init') {
            steps {
                sh "terraform -chdir=tf-provision init -input=false"
            }
        }
        stage('tf destroy') {
            steps {
                sh "terraform -chdir=tf-provision destroy -auto-approve -input=false"
            }
        }
        stage('tf db init') {
            steps {
                sh "terraform -chdir=tf-db init -input=false"
            }
        }
        stage('tf db destroy') {
            when {
                expression { return params.DESTROY_DB }
            }
            steps {
                sh "terraform -chdir=tf-db destroy -auto-approve -input=false"
            }
        }
    }
}